# Collide User Service - ç”¨æˆ·å¾®æœåŠ¡

åŸºäº FastAPI 3.11 å¼€å‘çš„ç”¨æˆ·å¾®æœåŠ¡ï¼Œé‡‡ç”¨é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰å’Œæ— è¿è¡¨è®¾è®¡åŸåˆ™ã€‚æ”¯æŒSpring Gateway + Sa-Tokenæ¶æ„ï¼Œé›†æˆNacosæœåŠ¡æ³¨å†Œä¸å‘ç°ã€‚

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

```
Collide-api/
â”œâ”€â”€ app/                          # åº”ç”¨ä¸»ç›®å½•
â”‚   â”œâ”€â”€ common/                   # å…¬å…±æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ config.py            # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ response.py          # ç»Ÿä¸€å“åº”æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ exceptions.py        # è‡ªå®šä¹‰å¼‚å¸¸
â”‚   â”‚   â”œâ”€â”€ security.py          # å®‰å…¨ç›¸å…³ï¼ˆJWTã€å¯†ç åŠ å¯†ï¼‰
â”‚   â”‚   â”œâ”€â”€ pagination.py        # åˆ†é¡µå·¥å…·
â”‚   â”‚   â”œâ”€â”€ dependencies.py      # FastAPIä¾èµ–é¡¹
â”‚   â”‚   â””â”€â”€ exception_handlers.py # å…¨å±€å¼‚å¸¸å¤„ç†å™¨
â”‚   â”œâ”€â”€ database/                 # æ•°æ®åº“æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ connection.py        # æ•°æ®åº“è¿æ¥é…ç½®
â”‚   â”‚   â””â”€â”€ models.py            # SQLAlchemyæ¨¡å‹
â”‚   â””â”€â”€ domains/                  # ä¸šåŠ¡åŸŸæ¨¡å—
â”‚       â””â”€â”€ users/               # ç”¨æˆ·åŸŸ
â”‚           â”œâ”€â”€ schemas.py       # Pydanticæ¨¡å‹
â”‚           â”œâ”€â”€ service.py       # ä¸šåŠ¡æœåŠ¡å±‚
â”‚           â””â”€â”€ router.py        # APIè·¯ç”±
â”œâ”€â”€ sql/                         # SQLæ•°æ®åº“æ–‡ä»¶
â”œâ”€â”€ main.py                      # ä¸»åº”ç”¨æ–‡ä»¶
â”œâ”€â”€ start.py                     # å¯åŠ¨è„šæœ¬
â”œâ”€â”€ requirements.txt             # ä¾èµ–åŒ…
â””â”€â”€ .env.example                # ç¯å¢ƒå˜é‡ç¤ºä¾‹
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

- Python 3.11+
- MySQL 8.0+

### 2. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

å¤åˆ¶ `.env.example` ä¸º `.env` å¹¶ä¿®æ”¹é…ç½®ï¼š

```bash
cp .env.example .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```env
# æ•°æ®åº“é…ç½®
DATABASE_URL=mysql+pymysql://username:password@localhost:3306/collide

# JWTé…ç½®
JWT_SECRET_KEY=your-super-secret-jwt-key-here

# å…¶ä»–é…ç½®...
```

### 4. é…ç½®Nacosï¼ˆå¯é€‰ï¼‰

å¦‚æœä½¿ç”¨æœåŠ¡æ³¨å†Œä¸å‘ç°ï¼š

```bash
# å¯åŠ¨NacosæœåŠ¡å™¨ï¼ˆå•æœºæ¨¡å¼ï¼‰
# ä¸‹è½½å¹¶è§£å‹Nacosï¼šhttps://nacos.io/zh-cn/docs/quick-start.html
cd nacos/bin
./startup.sh -m standalone

# è®¿é—®Nacosæ§åˆ¶å°ï¼šhttp://localhost:8848/nacos
# é»˜è®¤ç”¨æˆ·åå¯†ç ï¼šnacos/nacos
```

### 5. åˆå§‹åŒ–æ•°æ®åº“

æ‰§è¡Œ `sql/` ç›®å½•ä¸‹çš„ SQL æ–‡ä»¶æ¥åˆ›å»ºæ•°æ®åº“è¡¨ï¼š

```bash
# åˆ›å»ºæ•°æ®åº“
mysql -u root -p -e "CREATE DATABASE collide;"

# æ‰§è¡Œç”¨æˆ·æ¨¡å—SQL
mysql -u root -p collide < sql/users-simple.sql
```

### 6. å¯åŠ¨æœåŠ¡

```bash
# æ–¹å¼1ï¼šä½¿ç”¨å¯åŠ¨è„šæœ¬
python start.py

# æ–¹å¼2ï¼šç›´æ¥è¿è¡Œ
python main.py

# æ–¹å¼3ï¼šä½¿ç”¨ uvicorn
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

### 7. è®¿é—®APIæ–‡æ¡£

å¯åŠ¨åè®¿é—®ï¼š
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc
- å¥åº·æ£€æŸ¥: http://localhost:8000/health
- æœåŠ¡ä¿¡æ¯: http://localhost:8000/

å¦‚æœå¯ç”¨äº†Nacosï¼Œå¯ä»¥åœ¨Nacosæ§åˆ¶å°æŸ¥çœ‹æœåŠ¡æ³¨å†Œæƒ…å†µã€‚

## ğŸ›ï¸ å¾®æœåŠ¡æ¶æ„

æœ¬æœåŠ¡è®¾è®¡ä¸ºå¾®æœåŠ¡æ¶æ„ä¸­çš„ç”¨æˆ·æœåŠ¡ç»„ä»¶ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯åº”ç”¨      â”‚â”€â”€â”€â–¶â”‚  Spring Gateway  â”‚â”€â”€â”€â–¶â”‚  Sa-Tokenè®¤è¯   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚                         â”‚
                              â–¼                         â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚    Nacos    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ User Service    â”‚
                       â”‚ æœåŠ¡æ³¨å†Œä¸­å¿ƒ  â”‚         â”‚  (æœ¬æœåŠ¡)       â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚                         â”‚
                              â–¼                         â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚ å…¶ä»–å¾®æœåŠ¡   â”‚         â”‚    MySQL        â”‚
                       â”‚ Contentç­‰    â”‚         â”‚   ç”¨æˆ·æ•°æ®åº“     â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶æ„ç‰¹ç‚¹ï¼š

1. **æœåŠ¡æ³¨å†Œ** - è‡ªåŠ¨æ³¨å†Œåˆ°Nacosï¼Œæ”¯æŒæœåŠ¡å‘ç°
2. **ç»Ÿä¸€ç½‘å…³** - é€šè¿‡Spring Gatewayç»Ÿä¸€å…¥å£
3. **è®¤è¯åˆ†ç¦»** - Sa-Tokenå¤„ç†è®¤è¯ï¼ŒæœåŠ¡ä¸“æ³¨ä¸šåŠ¡é€»è¾‘
4. **å¤´éƒ¨ä¼ é€’** - ç½‘å…³å°†ç”¨æˆ·ä¿¡æ¯é€šè¿‡HTTPå¤´ä¼ é€’ç»™æœåŠ¡
5. **å¥åº·æ£€æŸ¥** - æä¾›å¤šä¸ªå¥åº·æ£€æŸ¥ç«¯ç‚¹
6. **ä¼˜é›…å…³é—­** - æ”¯æŒä¿¡å·å¤„ç†å’ŒæœåŠ¡æ³¨é”€

### è¯·æ±‚æµç¨‹ï¼š

1. å®¢æˆ·ç«¯è¯·æ±‚åˆ°è¾¾Spring Gateway
2. Gatewayè¿›è¡Œè·¯ç”±å’ŒSa-Tokenè®¤è¯
3. è®¤è¯æˆåŠŸåï¼ŒGatewayå°†ç”¨æˆ·ä¿¡æ¯æ·»åŠ åˆ°è¯·æ±‚å¤´
4. è¯·æ±‚è½¬å‘åˆ°å¯¹åº”çš„å¾®æœåŠ¡
5. å¾®æœåŠ¡ä»è¯·æ±‚å¤´è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå¤„ç†ä¸šåŠ¡é€»è¾‘

## ğŸ“š API è®¾è®¡åŸåˆ™

### 1. ç»Ÿä¸€å“åº”æ ¼å¼

#### æˆåŠŸå“åº”
```json
{
  "code": 200,
  "message": "success",
  "data": {...},
  "success": true
}
```

#### é”™è¯¯å“åº”
```json
{
  "code": 400,
  "message": "error message",
  "data": null,
  "success": false
}
```

#### åˆ†é¡µå“åº”
```json
{
  "success": true,
  "code": "200",
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "datas": {...},
    "total": 100,
    "currentPage": 1,
    "pageSize": 20,
    "totalPage": 5
  }
}
```

### 2. é”™è¯¯ç è§„èŒƒ

- `200`: æˆåŠŸ
- `400`: è¯·æ±‚å‚æ•°é”™è¯¯
- `401`: æœªæˆæƒ
- `403`: æ— æƒé™
- `404`: èµ„æºä¸å­˜åœ¨
- `500`: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

ä¸šåŠ¡é”™è¯¯ç ï¼š
- `1001`: ç”¨æˆ·ä¸å­˜åœ¨
- `1002`: ç”¨æˆ·å·²å­˜åœ¨
- `1003`: ç™»å½•å‡­è¯æ— æ•ˆ
- `1004`: ä½™é¢ä¸è¶³
- `1005`: æ“ä½œå¤±è´¥

## ğŸ”§ ç”¨æˆ·å¾®æœåŠ¡API

### å†…éƒ¨æœåŠ¡æ¥å£ï¼ˆä¾›è®¤è¯æœåŠ¡è°ƒç”¨ï¼‰
- `POST /api/users/internal/create` - åˆ›å»ºç”¨æˆ·
- `POST /api/users/internal/verify-password` - éªŒè¯ç”¨æˆ·å¯†ç 
- `POST /api/users/internal/find-by-identifier` - æ ¹æ®ç™»å½•æ ‡è¯†ç¬¦æŸ¥æ‰¾ç”¨æˆ·
- `POST /api/users/internal/update-login-info/{user_id}` - æ›´æ–°ç™»å½•ä¿¡æ¯

### ç”¨æˆ·ä¿¡æ¯
- `GET /api/users/me` - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
- `GET /api/users/{user_id}` - è·å–æŒ‡å®šç”¨æˆ·ä¿¡æ¯
- `PUT /api/users/me` - æ›´æ–°ç”¨æˆ·ä¿¡æ¯
- `PUT /api/users/password` - ä¿®æ”¹å¯†ç 

### é’±åŒ…ç®¡ç†
- `GET /api/users/me/wallet` - è·å–é’±åŒ…ä¿¡æ¯
- `POST /api/users/me/wallet/coin/grant` - å‘æ”¾é‡‘å¸å¥–åŠ±
- `POST /api/users/me/wallet/coin/consume` - æ¶ˆè´¹é‡‘å¸

### ç”¨æˆ·æ‹‰é»‘
- `POST /api/users/me/blocks` - æ‹‰é»‘ç”¨æˆ·
- `DELETE /api/users/me/blocks/{user_id}` - å–æ¶ˆæ‹‰é»‘
- `GET /api/users/me/blocks` - è·å–æ‹‰é»‘åˆ—è¡¨

### ç”¨æˆ·åˆ—è¡¨
- `GET /api/users` - è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆæ”¯æŒæœç´¢ç­›é€‰ï¼‰

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

1. **ç½‘å…³è®¤è¯** - é€šè¿‡Spring Gateway + Sa-Tokenè¿›è¡Œç»Ÿä¸€è®¤è¯
2. **å¯†ç åŠ å¯†** - ä½¿ç”¨bcryptè¿›è¡Œå¯†ç å“ˆå¸Œ
3. **è¯·æ±‚éªŒè¯** - Pydanticæ¨¡å‹éªŒè¯æ‰€æœ‰è¾“å…¥
4. **SQLæ³¨å…¥é˜²æŠ¤** - SQLAlchemy ORMé˜²æ­¢SQLæ³¨å…¥
5. **CORSé…ç½®** - ç”Ÿäº§ç¯å¢ƒé™åˆ¶è·¨åŸŸè®¿é—®
6. **å¤´éƒ¨ä¼ é€’** - ä»ç½‘å…³è·å–ç”¨æˆ·èº«ä»½ä¿¡æ¯

## ğŸ”¨ å¼€å‘è§„èŒƒ

### 1. ä»£ç ç»“æ„
- **é¢†åŸŸé©±åŠ¨è®¾è®¡**: æŒ‰ä¸šåŠ¡åŸŸç»„ç»‡ä»£ç 
- **åˆ†å±‚æ¶æ„**: Router â†’ Service â†’ Database
- **ä¾èµ–æ³¨å…¥**: ä½¿ç”¨FastAPIçš„ä¾èµ–æ³¨å…¥ç³»ç»Ÿ

### 2. æ•°æ®åº“è®¾è®¡
- **æ— è¿è¡¨åŸåˆ™**: é€šè¿‡å†—ä½™å­—æ®µé¿å…å¤æ‚è¿è¡¨æŸ¥è¯¢
- **å­—æ®µå†—ä½™**: é€‚å½“å†—ä½™æé«˜æŸ¥è¯¢æ€§èƒ½
- **ç´¢å¼•ä¼˜åŒ–**: ä¸ºé«˜é¢‘æŸ¥è¯¢å­—æ®µå»ºç«‹ç´¢å¼•

### 3. é”™è¯¯å¤„ç†
- **è‡ªå®šä¹‰å¼‚å¸¸**: ä¸šåŠ¡å¼‚å¸¸ç»§æ‰¿BusinessException
- **å…¨å±€å¤„ç†**: ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†å™¨
- **æ—¥å¿—è®°å½•**: å®Œæ•´çš„é”™è¯¯æ—¥å¿—

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

1. **æ•°æ®åº“è¿æ¥æ± ** - SQLAlchemyè¿æ¥æ± ç®¡ç†
2. **æŸ¥è¯¢ä¼˜åŒ–** - é¿å…N+1æŸ¥è¯¢é—®é¢˜
3. **å“åº”ç¼“å­˜** - å¯æ‰©å±•Redisç¼“å­˜
4. **åˆ†é¡µæŸ¥è¯¢** - æ‰€æœ‰åˆ—è¡¨æ¥å£æ”¯æŒåˆ†é¡µ

## ğŸ§ª æµ‹è¯•

```bash
# å®‰è£…æµ‹è¯•ä¾èµ–
pip install pytest pytest-asyncio

# è¿è¡Œæµ‹è¯•
pytest
```

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚