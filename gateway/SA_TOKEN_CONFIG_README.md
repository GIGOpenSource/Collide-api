# Sa-Token ç½‘å…³è®¤è¯é…ç½®æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜äº†ä¸ºCollideç”¨æˆ·å¾®æœåŠ¡é¡¹ç›®é…ç½®çš„Sa-Tokenç½‘å…³è®¤è¯è§„åˆ™ã€‚é…ç½®åŒ…å«ä¸¤ä¸ªä¸»è¦æ–‡ä»¶ï¼š

- `SaTokenConfigure.java` - å®šä¹‰APIè·¯å¾„çš„è®¤è¯è§„åˆ™
- `StpInterfaceImpl.java` - å®šä¹‰ç”¨æˆ·è§’è‰²å’Œæƒé™ä½“ç³»

## è§’è‰²ä½“ç³»

### è§’è‰²å±‚çº§
```
admin (ç®¡ç†å‘˜)
â”œâ”€â”€ blogger (åšä¸»)
â”œâ”€â”€ vip (VIPç”¨æˆ·)
â””â”€â”€ user (æ™®é€šç”¨æˆ·)
```

### è§’è‰²æƒé™
| è§’è‰² | æƒé™è¯´æ˜ |
|------|----------|
| **admin** | æ‹¥æœ‰æ‰€æœ‰æƒé™ï¼ŒåŒ…æ‹¬ç³»ç»Ÿç®¡ç†ã€ç”¨æˆ·ç®¡ç†ç­‰ |
| **blogger** | æ‹¥æœ‰åšä¸»æƒé™å’Œé’±åŒ…ç®¡ç†æƒé™ |
| **vip** | æ‹¥æœ‰VIPæƒé™å’Œé’±åŒ…ç®¡ç†æƒé™ |
| **user** | åŸºç¡€ç”¨æˆ·æƒé™ï¼ŒåŒ…æ‹¬ç¼–è¾‘ä¸ªäººä¿¡æ¯ã€æŸ¥çœ‹é’±åŒ… |

### ç‰¹æ®Šæƒé™æ£€æŸ¥
- **VIPæƒé™**: é™¤äº†roleå­—æ®µå¤–ï¼Œè¿˜ä¼šæ£€æŸ¥`vip_expire_time`å­—æ®µæ¥åŠ¨æ€åˆ¤æ–­VIPæƒé™
- **çŠ¶æ€æ£€æŸ¥**: åªæœ‰çŠ¶æ€ä¸º`active`çš„ç”¨æˆ·æ‰èƒ½è·å¾—æƒé™

## APIè·¯å¾„è®¤è¯è§„åˆ™

### ğŸ”“ æ— éœ€è®¤è¯çš„æ¥å£

#### ç³»ç»Ÿæ¥å£
- `/favicon.ico` - ç½‘ç«™å›¾æ ‡
- `/actuator/health` - å¥åº·æ£€æŸ¥
- `/health` - å¥åº·æ£€æŸ¥
- `/` - æ ¹è·¯å¾„æœåŠ¡ä¿¡æ¯

#### è®¤è¯æœåŠ¡å…¬å¼€æ¥å£
- `/api/v1/auth/login` - ç”¨æˆ·ç™»å½•
- `/api/v1/auth/register` - ç”¨æˆ·æ³¨å†Œ
- `/api/v1/auth/login-or-register` - ç™»å½•æˆ–æ³¨å†Œ
- `/api/v1/auth/validate-invite-code` - éªŒè¯é‚€è¯·ç 
- `/api/v1/auth/test` - æµ‹è¯•æ¥å£

#### ç”¨æˆ·æœåŠ¡å†…éƒ¨æ¥å£ï¼ˆæœåŠ¡é—´è°ƒç”¨ï¼‰
- `/api/v1/users/internal/**` - æ‰€æœ‰å†…éƒ¨æ¥å£

#### å…¶ä»–å…¬å¼€æ¥å£
- `/api/v1/users/{userId}` (GET) - è·å–æŒ‡å®šç”¨æˆ·ä¿¡æ¯ï¼ˆå¯é€‰ç™»å½•ï¼‰

### ğŸ”’ éœ€è¦ç™»å½•çš„æ¥å£

#### è®¤è¯æœåŠ¡
- `/api/v1/auth/logout` - ç”¨æˆ·ç™»å‡º
- `/api/v1/auth/me` - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
- `/api/v1/auth/verify-token` - éªŒè¯Token
- `/api/v1/auth/my-invite-info` - è·å–é‚€è¯·ä¿¡æ¯

#### ç”¨æˆ·æœåŠ¡ - åŸºç¡€åŠŸèƒ½
- `/api/v1/users/me` (GET/PUT) - è·å–/æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯
- `/api/v1/users/password` (PUT) - ä¿®æ”¹å¯†ç 
- `/api/v1/users/me/wallet` (GET) - è·å–å½“å‰ç”¨æˆ·é’±åŒ…ä¿¡æ¯
- `/api/v1/users/me/wallet/coin/**` - é‡‘å¸æ“ä½œ
- `/api/v1/users/me/blocks` - æ‹‰é»‘ç®¡ç†
- `/api/v1/users/{userId}/wallet` (GET) - è·å–æŒ‡å®šç”¨æˆ·é’±åŒ…ï¼ˆéœ€æƒé™ï¼‰
- `/api/v1/users` (GET) - è·å–ç”¨æˆ·åˆ—è¡¨

### ğŸ–ï¸ éœ€è¦ç‰¹å®šè§’è‰²çš„æ¥å£

#### Adminè§’è‰²éœ€æ±‚
- `/admin/**` - æ‰€æœ‰ç®¡ç†åŠŸèƒ½

## æƒé™éªŒè¯æµç¨‹

### 1. ç”¨æˆ·ä¿¡æ¯è·å–
ä»Sa-Token Sessionä¸­è·å–`userInfo`å¯¹è±¡ï¼ŒåŒ…å«ï¼š
```json
{
  "role": "user|blogger|vip|admin",
  "status": "active|inactive|blocked",
  "vip_expire_time": "2024-12-31T23:59:59",
  "user_id": 123,
  "username": "example"
}
```

### 2. çŠ¶æ€æ£€æŸ¥
- åªæœ‰`status = "active"`çš„ç”¨æˆ·æ‰èƒ½é€šè¿‡è®¤è¯
- éæ´»è·ƒç”¨æˆ·è¿”å›ç©ºæƒé™/è§’è‰²åˆ—è¡¨

### 3. è§’è‰²ç»§æ‰¿
- `admin` â†’ åŒ…å« `blogger`, `vip`, `user`
- `blogger` â†’ åŒ…å« `user`
- `vip` â†’ åŒ…å« `user`

### 4. åŠ¨æ€VIPæ£€æŸ¥
é™¤äº†è§’è‰²å­—æ®µå¤–ï¼Œè¿˜ä¼šæ£€æŸ¥`vip_expire_time`ï¼š
- å¦‚æœå½“å‰æ—¶é—´ < VIPè¿‡æœŸæ—¶é—´ï¼Œè‡ªåŠ¨æ·»åŠ VIPè§’è‰²å’Œæƒé™
- æ”¯æŒå­—ç¬¦ä¸²ï¼ˆISOæ ¼å¼ï¼‰å’Œæ—¶é—´æˆ³æ ¼å¼

## é”™è¯¯å¤„ç†

### è®¤è¯å¼‚å¸¸å¤„ç†
- `401` - æœªç™»å½•ï¼š`è¯·å…ˆç™»å½•`
- `403` - æƒé™ä¸è¶³ï¼š
  - ç®¡ç†å‘˜æƒé™ï¼š`éœ€è¦ç®¡ç†å‘˜æƒé™`
  - åšä¸»æƒé™ï¼š`éœ€è¦åšä¸»è®¤è¯`
  - VIPæƒé™ï¼š`éœ€è¦VIPæƒé™`
  - é€šç”¨æƒé™ï¼š`æƒé™ä¸è¶³`
- `500` - ç³»ç»Ÿé”™è¯¯ï¼š`è®¤è¯å¤±è´¥`

## é…ç½®æ³¨æ„äº‹é¡¹

### 1. å†…éƒ¨æ¥å£æ”¾è¡Œ
ç”¨æˆ·æœåŠ¡çš„å†…éƒ¨æ¥å£ï¼ˆ`/api/v1/users/internal/**`ï¼‰å®Œå…¨æ”¾è¡Œï¼Œå› ä¸ºè¿™äº›æ˜¯å¾®æœåŠ¡ä¹‹é—´çš„å†…éƒ¨è°ƒç”¨ã€‚

### 2. å¯é€‰ç™»å½•æ¥å£
æŸäº›æ¥å£å¦‚è·å–æŒ‡å®šç”¨æˆ·ä¿¡æ¯æ”¯æŒå¯é€‰ç™»å½•ï¼Œæœªç™»å½•æ—¶è¿”å›å…¬å¼€ä¿¡æ¯ï¼Œç™»å½•æ—¶è¿”å›æ›´è¯¦ç»†ä¿¡æ¯ã€‚

### 3. æƒé™ç²’åº¦
é…ç½®æ”¯æŒç»†ç²’åº¦çš„æƒé™æ§åˆ¶ï¼Œå¯ä»¥æ ¹æ®å…·ä½“ä¸šåŠ¡éœ€æ±‚è°ƒæ•´æƒé™åˆ†é…ã€‚

### 4. VIPæƒé™çš„ç‰¹æ®Šå¤„ç†
VIPæƒé™æ”¯æŒåŸºäºæ—¶é—´çš„åŠ¨æ€æ£€æŸ¥ï¼Œè¿™æ ·å¯ä»¥å‡†ç¡®æ§åˆ¶VIPæƒé™çš„æœ‰æ•ˆæœŸã€‚

## ä½¿ç”¨ç¤ºä¾‹

### åœ¨ä¸šåŠ¡ä»£ç ä¸­æ£€æŸ¥æƒé™
```java
// æ£€æŸ¥æ˜¯å¦ç™»å½•
StpUtil.checkLogin();

// æ£€æŸ¥è§’è‰²
StpUtil.checkRole("admin");
StpUtil.checkRoleOr("blogger", "admin");

// æ£€æŸ¥æƒé™
StpUtil.checkPermission("user_manage");
StpUtil.checkPermissionOr("vip", "admin");
```

### åœ¨Gatewayä¸­çš„åº”ç”¨
```java
// éœ€è¦ç™»å½•
SaRouter.match("/api/v1/users/me").check(r -> StpUtil.checkLogin());

// éœ€è¦ç‰¹å®šè§’è‰²
SaRouter.match("/admin/**").check(r -> {
    StpUtil.checkLogin();
    StpUtil.checkRole("admin");
});

// éœ€è¦ç‰¹å®šæƒé™
SaRouter.match("/api/v1/users").check(r -> {
    StpUtil.checkLogin();
    StpUtil.checkPermissionOr("user_manage", "admin");
});
```

## éƒ¨ç½²å»ºè®®

1. **ç½‘å…³é…ç½®**: ç¡®ä¿Gatewayæ­£ç¡®ä¼ é€’ç”¨æˆ·ä¿¡æ¯åˆ°åç«¯å¾®æœåŠ¡
2. **Sessionå­˜å‚¨**: å»ºè®®ä½¿ç”¨Redisç­‰å¤–éƒ¨å­˜å‚¨æ¥ä¿å­˜ç”¨æˆ·Sessionä¿¡æ¯
3. **æƒé™ç¼“å­˜**: è€ƒè™‘ç¼“å­˜ç”¨æˆ·æƒé™ä¿¡æ¯ä»¥æé«˜æ€§èƒ½
4. **ç›‘æ§æ—¥å¿—**: å…³æ³¨è®¤è¯å¼‚å¸¸æ—¥å¿—ï¼ŒåŠæ—¶å‘ç°æƒé™é…ç½®é—®é¢˜
